name: "Docker Build & Security Scan"

on:
  push:
    branches: ["main"]
    paths:
      - "platform/**"
      - "docker-compose.yml"
      - ".github/workflows/docker-build.yml"
  pull_request:
    branches: ["main"]
    paths:
      - "platform/**"
      - "docker-compose.yml"
      - ".github/workflows/docker-build.yml"

jobs:
  build-and-scan:
    name: "Build & Scan Docker Images"
    runs-on: ubuntu-latest

    strategy:
      matrix:
        service:
          - name: governance-engine
            context: platform/governance-engine
          - name: mcp-brave
            context: platform/mcp-servers/brave-search
          - name: mcp-salesforce
            context: platform/mcp-servers/salesforce
          - name: mcp-slack
            context: platform/mcp-servers/slack
          - name: mcp-cognism
            context: platform/mcp-servers/cognism
          - name: mcp-jira
            context: platform/mcp-servers/jira
          - name: mcp-google-workspace
            context: platform/mcp-servers/google-workspace

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: ${{ matrix.service.context }}
          push: false
          load: true
          tags: atlasynq/${{ matrix.service.name }}:ci
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Run Trivy vulnerability scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: atlasynq/${{ matrix.service.name }}:ci
          format: "table"
          exit-code: "0"
          severity: "CRITICAL,HIGH"
          ignore-unfixed: true

  lint:
    name: "Python Lint"
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install ruff
        run: pip install ruff

      - name: Run ruff check
        working-directory: platform/governance-engine
        run: ruff check --select E,W,F --ignore E501 .
        continue-on-error: true

  compose-validate:
    name: "Validate Docker Compose"
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create platform .env for validation
        run: mkdir -p platform && touch platform/.env

      - name: Validate docker-compose.yml
        run: docker compose config --quiet
        env:
          POSTGRES_PASSWORD: test
          MONGO_PASSWORD: test
          JWT_SECRET: test
          JWT_REFRESH_SECRET: test
          ATLASYNQ_API_KEY: test
          ANTHROPIC_API_KEY: test
          ENCRYPTION_KEY: test
          CORS_ALLOWED_ORIGINS: http://localhost
          SLACK_BOT_TOKEN: test
          SLACK_APP_TOKEN: test
          SLACK_USER_TOKEN: test
          SLACK_ALERT_USER_ID: test
          SLACK_CLIENT_ID: test
          SLACK_CLIENT_SECRET: test
          SLACK_REDIRECT_URI: test
          SLACK_SIGNING_SECRET: test
          GOOGLE_CLIENT_ID: test
          GOOGLE_CLIENT_SECRET: test
          GOOGLE_REDIRECT_URI: test
          GOOGLE_REFRESH_TOKEN: test
          SALESFORCE_MY_DOMAIN: test
          SALESFORCE_CLIENT_ID: test
          SALESFORCE_CLIENT_SECRET: test
          SALESFORCE_REDIRECT_URI: test
          SALESFORCE_USERNAME: test
          SALESFORCE_PASSWORD: test
          SALESFORCE_SECURITY_TOKEN: test
          SALESFORCE_LOGIN_URL: test
          COGNISM_API_KEY: test
          COGNISM_API_URL: test
          JIRA_CLIENT_ID: test
          JIRA_CLIENT_SECRET: test
          JIRA_REDIRECT_URI: test
          BRAVE_SEARCH_API_KEY: test
          OPENID_ISSUER: test
          OPENID_CALLBACK_URL: test
          OPENID_SCOPE: test
          GRAFANA_ADMIN_USER: admin
          GRAFANA_ADMIN_PASSWORD: test
          FEATURE_POLICY_GATEWAY: "0"
          FEATURE_CONTROL_PLANE_AUTH: "0"
          FEATURE_SHADOW_POLICY: "0"
          FEATURE_NEW_SECRET_STORE: "0"
          CP_JWT_SECRET: test
          CP_JWT_ACCESS_TTL: "900"
