###############################################################################
# AtlaSynq — Consolidated Docker Compose
# Run: docker compose up -d
###############################################################################

services:
  # ── Databases ──────────────────────────────────────────────────────────────

  db:
    image: postgres:15-alpine
    container_name: atlasynq-db
    environment:
      POSTGRES_USER: atlasynq
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: atlasynq_governance
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U atlasynq -d atlasynq_governance"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - atlasynq-network
    restart: unless-stopped

  mongodb:
    image: mongo:7.0
    container_name: atlasynq-mongodb
    environment:
      MONGO_INITDB_ROOT_USERNAME: atlasynq
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_PASSWORD}
      MONGO_INITDB_DATABASE: librechat
    volumes:
      - mongodb_data:/data/db
    ports:
      - "27017:27017"
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - atlasynq-network
    restart: unless-stopped

  redis:
    image: redis:alpine
    container_name: atlasynq-redis
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    volumes:
      - redis_data:/data
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 3
    networks:
      - atlasynq-network
    restart: unless-stopped

  # ── Core Services ──────────────────────────────────────────────────────────

  governance-engine:
    build:
      context: ./platform/governance-engine
      dockerfile: Dockerfile
    container_name: atlasynq-api
    env_file:
      - ./platform/.env
    environment:
      PYTHONUNBUFFERED: "1"
      DATABASE_URL: postgresql://atlasynq:${POSTGRES_PASSWORD}@db:5432/atlasynq_governance
      PORT: 8000
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY}
      ATLASYNQ_API_KEY: ${ATLASYNQ_API_KEY}
      CORS_ALLOWED_ORIGINS: ${CORS_ALLOWED_ORIGINS}
      API_BASE_URL: http://governance-engine:8000
      # Brave Search
      BRAVE_API_KEY: ${BRAVE_SEARCH_API_KEY}
      BRAVE_SEARCH_API_KEY: ${BRAVE_SEARCH_API_KEY}
      # Google OAuth
      GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID}
      GOOGLE_CLIENT_SECRET: ${GOOGLE_CLIENT_SECRET}
      GOOGLE_REDIRECT_URI: ${GOOGLE_REDIRECT_URI}
      GOOGLE_REFRESH_TOKEN: ${GOOGLE_REFRESH_TOKEN}
      # Slack
      SLACK_CLIENT_ID: ${SLACK_CLIENT_ID}
      SLACK_CLIENT_SECRET: ${SLACK_CLIENT_SECRET}
      SLACK_REDIRECT_URI: ${SLACK_REDIRECT_URI}
      SLACK_SIGNING_SECRET: ${SLACK_SIGNING_SECRET}
      SLACK_BOT_TOKEN: ${SLACK_BOT_TOKEN}
      SLACK_USER_TOKEN: ${SLACK_USER_TOKEN}
      # Salesforce
      SALESFORCE_MY_DOMAIN: ${SALESFORCE_MY_DOMAIN}
      SALESFORCE_CLIENT_ID: ${SALESFORCE_CLIENT_ID}
      SALESFORCE_CLIENT_SECRET: ${SALESFORCE_CLIENT_SECRET}
      SALESFORCE_REDIRECT_URI: ${SALESFORCE_REDIRECT_URI}
      SALESFORCE_USERNAME: ${SALESFORCE_USERNAME}
      SALESFORCE_PASSWORD: ${SALESFORCE_PASSWORD}
      SALESFORCE_SECURITY_TOKEN: ${SALESFORCE_SECURITY_TOKEN}
      SALESFORCE_LOGIN_URL: ${SALESFORCE_LOGIN_URL}
      # Cognism
      COGNISM_API_KEY: ${COGNISM_API_KEY}
      COGNISM_API_URL: ${COGNISM_API_URL}
      # Jira
      JIRA_CLIENT_ID: ${JIRA_CLIENT_ID}
      JIRA_CLIENT_SECRET: ${JIRA_CLIENT_SECRET}
      JIRA_REDIRECT_URI: ${JIRA_REDIRECT_URI}
      # MCP Server URLs
      MCP_BRAVE_URL: http://mcp-brave:8001
      MCP_SALESFORCE_URL: http://mcp-salesforce:8002
      MCP_SLACK_URL: http://mcp-slack:8003
      MCP_COGNISM_URL: http://mcp-cognism:8004
      MCP_JIRA_URL: http://mcp-jira:8005
      MCP_GOOGLE_WORKSPACE_URL: http://mcp-google-workspace:8006
      # Token encryption
      ENCRYPTION_KEY: ${ENCRYPTION_KEY}
      REDIS_URL: redis://redis:6379
      # Feature flags (default OFF — no behavior change)
      FEATURE_POLICY_GATEWAY: ${FEATURE_POLICY_GATEWAY:-0}
      FEATURE_CONTROL_PLANE_AUTH: ${FEATURE_CONTROL_PLANE_AUTH:-0}
      FEATURE_SHADOW_POLICY: ${FEATURE_SHADOW_POLICY:-0}
      FEATURE_NEW_SECRET_STORE: ${FEATURE_NEW_SECRET_STORE:-0}
    ports:
      - "8000:8000"
    volumes:
      - ./platform/governance-engine:/app
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - atlasynq-network
    restart: unless-stopped

  slack-listener:
    build:
      context: ./platform/governance-engine
      dockerfile: Dockerfile
    container_name: atlasynq-slack-listener
    command: python -m app.services.slack_listener
    healthcheck:
      test: ["CMD-SHELL", "python -c 'import os; exit(0 if os.path.exists(\"/proc/1/status\") else 1)'"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 30s
    env_file:
      - ./platform/.env
    environment:
      PYTHONUNBUFFERED: "1"
      DATABASE_URL: postgresql://atlasynq:${POSTGRES_PASSWORD}@db:5432/atlasynq_governance
      API_BASE_URL: http://governance-engine:8000
      # Slack
      SLACK_BOT_TOKEN: ${SLACK_BOT_TOKEN}
      SLACK_USER_TOKEN: ${SLACK_USER_TOKEN}
      SLACK_APP_TOKEN: ${SLACK_APP_TOKEN}
      SLACK_ALERT_USER_ID: ${SLACK_ALERT_USER_ID}
      # AI
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY}
      # Google
      GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID}
      GOOGLE_CLIENT_SECRET: ${GOOGLE_CLIENT_SECRET}
      GOOGLE_REFRESH_TOKEN: ${GOOGLE_REFRESH_TOKEN}
      # Brave Search
      BRAVE_SEARCH_API_KEY: ${BRAVE_SEARCH_API_KEY}
      # Salesforce Direct Auth
      SALESFORCE_USERNAME: ${SALESFORCE_USERNAME}
      SALESFORCE_PASSWORD: ${SALESFORCE_PASSWORD}
      SALESFORCE_SECURITY_TOKEN: ${SALESFORCE_SECURITY_TOKEN}
      SALESFORCE_LOGIN_URL: ${SALESFORCE_LOGIN_URL}
      SALESFORCE_MY_DOMAIN: ${SALESFORCE_MY_DOMAIN}
      # Cognism
      COGNISM_API_KEY: ${COGNISM_API_KEY}
      COGNISM_API_URL: ${COGNISM_API_URL}
      # MCP URLs
      MCP_JIRA_URL: http://mcp-jira:8005
      MCP_SALESFORCE_URL: http://mcp-salesforce:8002
      MCP_COGNISM_URL: http://mcp-cognism:8004
      # Token encryption
      ENCRYPTION_KEY: ${ENCRYPTION_KEY}
      # Redis (for persistent state across restarts)
      REDIS_URL: redis://redis:6379
    volumes:
      - ./platform/governance-engine:/app
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
      governance-engine:
        condition: service_started
    networks:
      - atlasynq-network
    restart: unless-stopped

  worker:
    build:
      context: ./platform/governance-engine
      dockerfile: Dockerfile
    container_name: atlasynq-worker
    command: arq app.workers.tasks.WorkerSettings
    healthcheck:
      test: ["CMD-SHELL", "python -c 'import os; exit(0 if os.path.exists(\"/proc/1/status\") else 1)'"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 15s
    env_file:
      - ./platform/.env
    environment:
      PYTHONUNBUFFERED: "1"
      REDIS_URL: redis://redis:6379
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY}
      SLACK_BOT_TOKEN: ${SLACK_BOT_TOKEN}
    volumes:
      - ./platform/governance-engine:/app
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - atlasynq-network
    restart: unless-stopped

  # ── MCP Servers ────────────────────────────────────────────────────────────

  mcp-brave:
    build:
      context: ./platform/mcp-servers/brave-search
      dockerfile: Dockerfile
    container_name: mcp-brave
    env_file:
      - ./platform/.env
    command: python server.py
    environment:
      PYTHONUNBUFFERED: "1"
      BRAVE_API_KEY: ${BRAVE_SEARCH_API_KEY}
      BRAVE_SEARCH_API_KEY: ${BRAVE_SEARCH_API_KEY}
    ports:
      - "8001:8001"
    healthcheck:
      test: ["CMD-SHELL", "python -c 'import socket; s=socket.socket(); s.settimeout(2); s.connect((\"localhost\",8001)); s.close()'"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 15s
    networks:
      - atlasynq-network
    restart: unless-stopped

  mcp-salesforce:
    build:
      context: ./platform/mcp-servers/salesforce
      dockerfile: Dockerfile
    container_name: mcp-salesforce
    env_file:
      - ./platform/.env
    command: python server.py
    environment:
      PYTHONUNBUFFERED: "1"
      SALESFORCE_CLIENT_ID: ${SALESFORCE_CLIENT_ID}
      SALESFORCE_CLIENT_SECRET: ${SALESFORCE_CLIENT_SECRET}
      SALESFORCE_MY_DOMAIN: ${SALESFORCE_MY_DOMAIN}
    ports:
      - "8002:8002"
    healthcheck:
      test: ["CMD-SHELL", "python -c 'import socket; s=socket.socket(); s.settimeout(2); s.connect((\"localhost\",8002)); s.close()'"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 15s
    networks:
      - atlasynq-network
    restart: unless-stopped

  mcp-slack:
    build:
      context: ./platform/mcp-servers/slack
      dockerfile: Dockerfile
    container_name: mcp-slack
    env_file:
      - ./platform/.env
    command: python server.py
    environment:
      PYTHONUNBUFFERED: "1"
    ports:
      - "8003:8003"
    healthcheck:
      test: ["CMD-SHELL", "python -c 'import socket; s=socket.socket(); s.settimeout(2); s.connect((\"localhost\",8003)); s.close()'"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 15s
    networks:
      - atlasynq-network
    restart: unless-stopped

  mcp-cognism:
    build:
      context: ./platform/mcp-servers/cognism
      dockerfile: Dockerfile
    container_name: mcp-cognism
    env_file:
      - ./platform/.env
    command: python server.py
    environment:
      PYTHONUNBUFFERED: "1"
      COGNISM_API_KEY: ${COGNISM_API_KEY}
      COGNISM_API_URL: ${COGNISM_API_URL}
    ports:
      - "8004:8004"
    healthcheck:
      test: ["CMD-SHELL", "python -c 'import socket; s=socket.socket(); s.settimeout(2); s.connect((\"localhost\",8004)); s.close()'"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 15s
    networks:
      - atlasynq-network
    restart: unless-stopped

  mcp-jira:
    build:
      context: ./platform/mcp-servers/jira
      dockerfile: Dockerfile
    container_name: mcp-jira
    env_file:
      - ./platform/.env
    command: python server.py
    environment:
      PYTHONUNBUFFERED: "1"
    ports:
      - "8005:8005"
    healthcheck:
      test: ["CMD-SHELL", "python -c 'import socket; s=socket.socket(); s.settimeout(2); s.connect((\"localhost\",8005)); s.close()'"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 15s
    networks:
      - atlasynq-network
    restart: unless-stopped

  mcp-google-workspace:
    build:
      context: ./platform/mcp-servers/google-workspace
      dockerfile: Dockerfile
    container_name: mcp-google-workspace
    env_file:
      - ./platform/.env
    command: python server.py
    environment:
      PYTHONUNBUFFERED: "1"
    ports:
      - "8006:8006"
    healthcheck:
      test: ["CMD-SHELL", "python -c 'import socket; s=socket.socket(); s.settimeout(2); s.connect((\"localhost\",8006)); s.close()'"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 15s
    networks:
      - atlasynq-network
    restart: unless-stopped

  # ── Control Plane (scaffolding — no routing, no auth) ───────────────────────

  control-plane-api:
    build:
      context: ./apps/control-plane-api
      dockerfile: Dockerfile
    container_name: atlasynq-control-plane-api
    environment:
      CP_DATABASE_URL: postgresql://atlasynq:${POSTGRES_PASSWORD}@db:5432/control_plane
      CP_JWT_SECRET: ${CP_JWT_SECRET:-dev-jwt-secret-change-in-production}
      CP_JWT_ACCESS_TTL: ${CP_JWT_ACCESS_TTL:-900}
    ports:
      - "8100:8100"
    depends_on:
      db:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8100/health || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    networks:
      - atlasynq-network
    restart: unless-stopped

  # ── Frontend ───────────────────────────────────────────────────────────────

  librechat:
    image: ghcr.io/danny-avila/librechat-dev:latest
    container_name: atlasynq-librechat
    env_file:
      - ./platform/.env
    environment:
      MONGO_URI: mongodb://atlasynq:${MONGO_PASSWORD}@mongodb:27017/librechat?authSource=admin
      BACKEND_URL: http://governance-engine:8000
      APP_TITLE: AtlaSynq
      APP_DESCRIPTION: Governed AI Agents for Enterprise
      JWT_SECRET: ${JWT_SECRET}
      JWT_REFRESH_SECRET: ${JWT_REFRESH_SECRET}
      SESSION_EXPIRY: "14400000"
      REFRESH_TOKEN_EXPIRY: "14400000"
      DOMAIN_CLIENT: "http://localhost:3080"
      DOMAIN_SERVER: "http://localhost:3080"
      OPENID_BUTTON_LABEL: "Log in with Salesforce"
      OPENID_ISSUER: "${OPENID_ISSUER}"
      OPENID_CLIENT_ID: "${SALESFORCE_CLIENT_ID}"
      OPENID_CLIENT_SECRET: "${SALESFORCE_CLIENT_SECRET}"
      OPENID_CALLBACK_URL: "${OPENID_CALLBACK_URL}"
      OPENID_SCOPE: "${OPENID_SCOPE}"
      ALLOW_REGISTRATION: "true"
      ALLOW_SOCIAL_LOGIN: "true"
      ALLOW_SOCIAL_REGISTRATION: "true"
      ATLASYNQ_API_KEY: ${ATLASYNQ_API_KEY}
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY}
      GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID}
      GOOGLE_CLIENT_SECRET: ${GOOGLE_CLIENT_SECRET}
      GOOGLE_REFRESH_TOKEN: ${GOOGLE_REFRESH_TOKEN}
      SLACK_BOT_TOKEN: ${SLACK_BOT_TOKEN}
    expose:
      - "3080"
    volumes:
      - ./platform/librechat/librechat.yaml:/app/librechat.yaml:ro
      - ./platform/.env:/app/.env:ro
      - librechat_data:/app/librechat_data
    depends_on:
      mongodb:
        condition: service_healthy
      governance-engine:
        condition: service_started
    networks:
      - atlasynq-network
    restart: unless-stopped

  # ── Infrastructure ─────────────────────────────────────────────────────────

  nginx:
    image: nginx:alpine
    container_name: atlasynq-nginx
    ports:
      - "3080:3080"
    volumes:
      - ./platform/nginx/nginx.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - librechat
      - governance-engine
    networks:
      - atlasynq-network
    restart: unless-stopped

  # ── Production HTTPS (activate with: docker compose --profile production up -d)
  nginx-ssl:
    image: nginx:alpine
    container_name: atlasynq-nginx-ssl
    profiles: ["production"]
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./platform/nginx/nginx-ssl.conf:/etc/nginx/templates/default.conf.template:ro
      - certbot_webroot:/var/www/certbot:ro
      - certbot_certs:/etc/letsencrypt:ro
    environment:
      DOMAIN: ${DOMAIN:-localhost}
    depends_on:
      - librechat
      - governance-engine
    networks:
      - atlasynq-network
    restart: unless-stopped

  certbot:
    image: certbot/certbot:latest
    container_name: atlasynq-certbot
    profiles: ["production"]
    volumes:
      - certbot_webroot:/var/www/certbot
      - certbot_certs:/etc/letsencrypt
    entrypoint: "/bin/sh -c 'trap exit TERM; while :; do certbot renew --webroot -w /var/www/certbot --quiet; sleep 12h & wait $${!}; done'"
    networks:
      - atlasynq-network

  dozzle:
    container_name: atlasynq-logs
    image: amir20/dozzle:latest
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    ports:
      - "8080:8080"
    networks:
      - atlasynq-network
    restart: always

  # ── Observability Stack ────────────────────────────────────────────────────

  prometheus:
    image: prom/prometheus:latest
    container_name: atlasynq-prometheus
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--storage.tsdb.retention.time=30d"
      - "--web.enable-lifecycle"
    volumes:
      - ./platform/observability/prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus_data:/prometheus
    ports:
      - "9090:9090"
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:9090/-/healthy"]
      interval: 15s
      timeout: 10s
      retries: 5
      start_period: 30s
    networks:
      - atlasynq-network
    restart: unless-stopped

  loki:
    image: grafana/loki:latest
    container_name: atlasynq-loki
    command: -config.file=/etc/loki/loki.yml
    volumes:
      - ./platform/observability/loki.yml:/etc/loki/loki.yml
      - loki_data:/loki
    ports:
      - "3100:3100"
    healthcheck:
      test: ["CMD-SHELL", "wget --spider -q http://localhost:3100/ready || exit 1"]
      interval: 15s
      timeout: 10s
      retries: 10
      start_period: 60s
    networks:
      - atlasynq-network
    restart: unless-stopped

  promtail:
    image: grafana/promtail:latest
    container_name: atlasynq-promtail
    command: -config.file=/etc/promtail/promtail.yml
    volumes:
      - ./platform/observability/promtail.yml:/etc/promtail/promtail.yml
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
    depends_on:
      loki:
        condition: service_started
    networks:
      - atlasynq-network
    restart: unless-stopped

  grafana:
    image: grafana/grafana:latest
    container_name: atlasynq-grafana
    environment:
      GF_SECURITY_ADMIN_USER: ${GRAFANA_ADMIN_USER:-admin}
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_ADMIN_PASSWORD:-atlasynq2024}
      GF_USERS_ALLOW_SIGN_UP: "false"
      GF_SERVER_ROOT_URL: "http://localhost:3000"
    volumes:
      - grafana_data:/var/lib/grafana
      - ./platform/observability/grafana/provisioning:/etc/grafana/provisioning
    ports:
      - "3000:3000"
    healthcheck:
      test: ["CMD-SHELL", "wget --spider -q http://localhost:3000/api/health || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 3
    depends_on:
      prometheus:
        condition: service_started
      loki:
        condition: service_started
    networks:
      - atlasynq-network
    restart: unless-stopped

volumes:
  postgres_data:
  mongodb_data:
  redis_data:
  librechat_data:
  prometheus_data:
  loki_data:
  grafana_data:
  certbot_webroot:
  certbot_certs:

networks:
  atlasynq-network:
    driver: bridge
